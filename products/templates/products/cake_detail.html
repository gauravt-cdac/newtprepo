{% extends "base.html" %}

{% block title %}{{ cake.title }} - Cake Details{% endblock %}

{% block content %}
<div class="container my-4" style="max-width: 960px;">
  <div class="row g-4">
    <!-- Images section -->
    <div class="col-md-6">
      <div class="image-gallery d-flex flex-column align-items-center">
        {% if cake.images.count > 0 %}
          <div class="mb-3 w-100" style="height: 320px; overflow: hidden; border-radius: 0.5rem; box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);">
            <img id="main-cake-image" src="{{ cake.images.first.image.url }}" alt="{{ cake.title }}" class="img-fluid w-100 h-100" 
                 style="object-fit: contain;">
          </div>
          {% if cake.images.count > 1 %}
            <div class="d-flex gap-2 overflow-auto" style="max-width: 100%;">
              {% for image in cake.images.all %}
                <img src="{{ image.image.url }}" alt="Cake Image {{ forloop.counter }}" 
                     class="thumb-image rounded border {% if forloop.first %}border-primary{% else %}border-secondary{% endif %}" 
                     style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;"
                     onclick="document.getElementById('main-cake-image').src=this.src; setActiveThumb(this);">
              {% endfor %}
            </div>
          {% endif %}
        {% else %}
          <div class="w-100 h-100 d-flex justify-content-center align-items-center" style="height: 320px; background: #f0f0f0; border-radius: 0.5rem;">
            <span class="text-muted">No images available</span>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Cake details & variants -->
    <div class="col-md-6 d-flex flex-column">
      <h1 class="mb-3">{{ cake.title }}</h1>
      <p class="text-secondary mb-3" style="white-space: pre-line;">{{ cake.description }}</p>
      <p><strong>Category:</strong> {{ cake.category.name }}</p>

      <div class="variants mt-4">
        <h5 class="mb-2">Select Variant</h5>
        <div class="btn-group" role="group" aria-label="Cake variants">
          {% for variant in variants %}
            <input type="radio" class="btn-check" name="variant" id="variant-{{ variant.id }}" autocomplete="off" 
                   value="{{ variant.id }}" {% if forloop.first %}checked{% endif %}>
            <label class="btn btn-outline-primary px-3" for="variant-{{ variant.id }}">
              {{ variant.weight }} kg - â‚¹{{ variant.price }}
              {% if not variant.is_in_stock %}
                <span class="badge bg-danger ms-1" style="font-size: 0.8rem;">Out of Stock</span>
              {% endif %}
            </label>
          {% endfor %}
        </div>
      </div>

      <div class="pt-4 mt-auto">
        {% if user.is_authenticated %}
          {% if user.role == 'buyer' %}
            <button id="add-to-cart-btn" class="btn btn-success btn-lg px-4" 
                    {% if variants|length == 0 %}disabled{% endif %}>
              Add to Cart
            </button>
          {% else %}
            <div class="alert alert-warning mt-3" role="alert">
              Only buyers can add products to cart.
            </div>
          {% endif %}
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-warning btn-lg px-4">
            Login to Buy
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  function setActiveThumb(selectedImg) {
    document.querySelectorAll('.thumb-image').forEach(img => {
      img.classList.remove('border-primary');
      img.classList.add('border-secondary');
    });
    selectedImg.classList.remove('border-secondary');
    selectedImg.classList.add('border-primary');
  }

  document.getElementById('add-to-cart-btn')?.addEventListener('click', function () {
    const selectedVariant = document.querySelector('input[name="variant"]:checked');
    if (!selectedVariant) {
      showToast('Please select a variant.', 'error');
      return;
    }
    const variantId = selectedVariant.value;
    fetch("{% url 'add_to_cart' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: `variant_id=${variantId}&quantity=1`
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('cart-count').textContent = data.cart_count;
        showToast('Added to cart successfully!', 'success');
      } else {
        showToast(data.message || 'Failed to add to cart.', 'error');
      }
    })
    .catch(() => showToast('An error occurred.', 'error'));
  });

  function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0 position-fixed bottom-0 end-0 m-3`;
    toast.style.zIndex = 1080;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay:4000 });
    bsToast.show();
    toast.addEventListener('hidden.bs.toast', () => {
      document.body.removeChild(toast);
    });
  }
</script>

<style>
  .btn-check:checked + .btn {
    background-color: #198754 !important;
    color: #fff !important;
    border-color: #198754 !important;
    font-weight: 600;
  }
  .thumb-image {
    border: 2px solid #ddd;
    transition: border-color 0.3s ease;
  }
  .thumb-image.border-primary {
    border-color: #198754 !important;
  }
  .thumb-image:hover {
    border-color: #198754;
    cursor: pointer;
  }
</style>
{% endblock %}
