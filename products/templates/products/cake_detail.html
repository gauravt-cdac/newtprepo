{% extends "base.html" %}
{% load static %}

{% block title %}{{ cake.title }} - Cake Details{% endblock %}

{% block content %}
<div class="container my-4" style="max-width: 960px;">
  <div class="row g-4">
    <!-- Images section -->
    <div class="col-md-6">
      <div class="image-gallery d-flex flex-column align-items-center">

        {% if cake.images.count > 0 %}
          <div class="mb-3 mx-auto image-container" style="
               max-width: 100%; 
               border-radius: 16px; 
               box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
               border: 1px solid rgba(0,0,0,0.1); 
               background: #fff; 
               display: flex; 
               align-items: center; 
               justify-content: center;">
            <img id="main-cake-image" src="{{ cake.images.first.image.url }}" alt="{{ cake.title }}" 
                 class="img-fluid rounded-img" style="object-fit: contain; max-height:320px; max-width:100%;">
          </div>
          {% if cake.images.count > 1 %}
            <div class="d-flex gap-2 overflow-auto" style="max-width: 100%;">
              {% for image in cake.images.all %}
                <img src="{{ image.image.url }}" alt="Cake Image {{ forloop.counter }}" 
                     class="thumb-image rounded border {% if forloop.first %}border-primary{% else %}border-secondary{% endif %}" 
                     style="width: 60px; height: 60px; object-fit: cover; cursor: pointer; border-radius: 8px;"
                     data-index="{{ forloop.counter0 }}"
                     onclick="selectImage({{ forloop.counter0 }}); pauseSlideshow();">
              {% endfor %}
            </div>
          {% endif %}
        {% else %}
          <div class="w-100 h-100 d-flex justify-content-center align-items-center" style="height: 320px; background: #f0f0f0; border-radius: 16px;">
            <span class="text-muted">No images available</span>
          </div>
        {% endif %}

      </div>
    </div>

    <!-- Cake details & variants -->
    <div class="col-md-6 d-flex flex-column">
      <h1 class="mb-3">{{ cake.title }}</h1>
      <p class="text-secondary mb-3" style="white-space: pre-line;">{{ cake.description }}</p>
      <p><strong>Category:</strong> {{ cake.category.name }}</p>

      <div class="variants mt-4">
        <h5 class="mb-2">Select Variant</h5>
        <div class="btn-group" role="group" aria-label="Cake variants">
          {% for variant in variants %}
            <input type="radio" class="btn-check" name="variant" id="variant-{{ variant.id }}" autocomplete="off" 
                   value="{{ variant.id }}" {% if forloop.first %}checked{% endif %}>
            <label class="btn btn-outline-primary px-3" for="variant-{{ variant.id }}">
              {{ variant.weight }} kg - â‚¹{{ variant.price }}
              {% if not variant.is_in_stock %}
                <span class="badge bg-danger ms-1" style="font-size: 0.8rem;">Out of Stock</span>
              {% endif %}
            </label>
          {% endfor %}
        </div>
      </div>

      <div class="pt-4 mt-auto">
        {% if user.is_authenticated %}
          {% if user.role == 'buyer' %}
            <button id="add-to-cart-btn" class="btn btn-success btn-lg px-4" 
                    {% if variants|length == 0 %}disabled{% endif %}>
              Add to Cart
            </button>
          {% else %}
            <div class="alert alert-warning mt-3" role="alert">
              Only buyers can add products to cart.
            </div>
          {% endif %}
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-warning btn-lg px-4">
            Login to Buy
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  // Manage active thumb styling
  function setActiveThumb(selectedImg) {
    document.querySelectorAll('.thumb-image').forEach(img => {
      img.classList.remove('border-primary');
      img.classList.add('border-secondary');
    });
    selectedImg.classList.remove('border-secondary');
    selectedImg.classList.add('border-primary');
  }

  // Select image by index from thumbnails
  function selectImage(index) {
    const images = document.querySelectorAll('.thumb-image');
    if (images.length === 0) return;

    let img = images[index];
    if (!img) return;

    let mainImage = document.getElementById('main-cake-image');
    mainImage.src = img.src;
    setActiveThumb(img);
    currentIndex = index;  // Update current index for slideshow
  }

  // Automatic slideshow variables
  let currentIndex = 0;
  let slideshowInterval;
  let isPaused = false;

  function startSlideshow() {
    const images = document.querySelectorAll('.thumb-image');
    if (images.length <= 1) return; // No slideshow if <=1 image

    slideshowInterval = setInterval(() => {
      if (isPaused) return;

      currentIndex = (currentIndex + 1) % images.length;
      selectImage(currentIndex);
    }, 2000);  // 2 seconds interval
  }

  function pauseSlideshow() {
    isPaused = true;
  }

  function resumeSlideshow() {
    isPaused = false;
  }

  // Pause slideshow on mouse enter on thumb container and resume on leave
  document.querySelectorAll('.thumb-image').forEach(img => {
    img.addEventListener('mouseenter', pauseSlideshow);
    img.addEventListener('mouseleave', resumeSlideshow);
  });

  // Start slideshow after DOM load
  document.addEventListener('DOMContentLoaded', () => {
    startSlideshow();
  });

  // Add-to-cart handler
  document.getElementById('add-to-cart-btn')?.addEventListener('click', function () {
    const selectedVariant = document.querySelector('input[name="variant"]:checked');
    if (!selectedVariant) {
      showToast('Please select a variant.', 'error');
      return;
    }
    const variantId = selectedVariant.value;
    fetch("{% url 'add_to_cart' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: `variant_id=${variantId}&quantity=1`
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('cart-count').textContent = data.cart_count;
        showToast('Added to cart successfully!', 'success');
      } else {
        showToast(data.message || 'Failed to add to cart.', 'error');
      }
    })
    .catch(() => showToast('An error occurred.', 'error'));
  });

  // Toast notification at top center
  function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0 position-fixed start-50 translate-middle-x mt-3`;
    toast.style.top = "20px";
    toast.style.left = "50%";
    toast.style.right = "auto";
    toast.style.marginRight = "0";
    toast.style.width = "auto";
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay:4000 });
    bsToast.show();
    toast.addEventListener('hidden.bs.toast', () => {
      document.body.removeChild(toast);
    });
  }
</script>

<style>
  .btn-check:checked + .btn {
    background-color: #198754 !important;
    color: #fff !important;
    border-color: #198754 !important;
    font-weight: 600;
  }
  .thumb-image {
    border: 2px solid #ddd;
    transition: border-color 0.3s ease;
    border-radius: 8px; /* Rounded corners */
  }
  .thumb-image.border-primary {
    border-color: #198754 !important;
  }
  .thumb-image:hover {
    border-color: #198754;
    cursor: pointer;
  }
  .image-container img.rounded-img {
    border-radius: 16px; /* More rounded corners on main image */
    transition: transform 0.3s ease;
  }
  .image-container img.rounded-img:hover {
    transform: scale(1.02);
  }
</style>
{% endblock %}
