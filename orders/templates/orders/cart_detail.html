{% extends "base.html" %}
{% load static %}

{% block title %}Your Cart{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 950px;">
    <h2>Your Shopping Cart</h2>

    {% if cart_items and cart %}
    <div class="table-responsive mt-3">
        <table class="table table-bordered align-middle">
            <thead class="table-light text-center">
                <tr>
                    <th>Product</th>
                    <th>Variant (Weight)</th>
                    <th style="width: 120px;">Quantity</th>
                    <th>Price (₹)</th>
                    <th>Total (₹)</th>
                    <th style="width: 80px;">Actions</th>
                </tr>
            </thead>
            <tbody id="cart-items-body">
                {% for item in cart_items %}
                <tr data-item-id="{{ item.id }}" class="cart-item-row">
                    <td>{{ item.variant.cake.title }}</td>
                    <td class="text-center">{{ item.variant.weight }} kg</td>
                    <td class="text-center">
                        <input type="number" class="form-control form-control-sm quantity-input" 
                               min="1" max="{{ item.variant.stock }}" value="{{ item.quantity }}" 
                               style="width: 70px; margin: 0 auto;" />
                        <small class="text-muted d-block mt-1">Stock: {{ item.variant.stock }}</small>
                    </td>
                    <td class="text-center">₹{{ item.variant.price|floatformat:2 }}</td>
                    <td class="text-center item-total-price">₹{{ item.get_total_price|floatformat:2 }}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm btn-remove-item" title="Remove item">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
        <h4>Total Price: <span id="cart-total-price">₹{{ cart.get_total_price|floatformat:2 }}</span></h4>
        <a href="{% url 'checkout' %}" class="btn btn-success btn-lg px-4">Proceed to Checkout</a>
    </div>

    {% else %}
    <p>Your cart is empty.</p>
    <a href="{% url 'cake_list' %}" class="btn btn-primary">Continue Shopping</a>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // CSRF token helper for AJAX
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Update cart item quantity via AJAX
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', function() {
            const row = this.closest('tr');
            const cartItemId = row.dataset.itemId;
            const newQuantity = parseInt(this.value);
            const maxStock = parseInt(this.max);

            if (isNaN(newQuantity) || newQuantity < 1) {
                alert('Quantity must be at least 1');
                this.value = 1;
                return;
            }
            if (newQuantity > maxStock) {
                alert('Quantity exceeds available stock');
                this.value = maxStock;
                return;
            }

            fetch("{% url 'update_cart_item' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken,
                },
                body: `cart_item_id=${cartItemId}&quantity=${newQuantity}`,
            })
            .then(response => response.json())
            .then(data => {
                if(data.success){
                    // Update item total
                    const itemTotalCell = row.querySelector('.item-total-price');
                    itemTotalCell.textContent = `₹${parseFloat(data.item_total).toFixed(2)}`;

                    // Update cart total
                    document.getElementById('cart-total-price').textContent = `₹${parseFloat(data.cart_total).toFixed(2)}`;
                } else {
                    alert(data.message || 'Failed to update cart.');
                    // Revert input to previous value if error
                    input.value = input.defaultValue;
                }
            })
            .catch(() => alert('Error updating cart. Please try again.'));
        });
    });

    // Remove cart item via AJAX
    document.querySelectorAll('.btn-remove-item').forEach(button => {
        button.addEventListener('click', function() {
            if (!confirm('Are you sure you want to remove this item from your cart?')) return;

            const row = this.closest('tr');
            const cartItemId = row.dataset.itemId;

            fetch("{% url 'update_cart_item' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken,
                },
                // Setting quantity to 0 or negative will remove the item server-side
                body: `cart_item_id=${cartItemId}&quantity=0`,
            })
            .then(response => response.json())
            .then(data => {
                if(data.success){
                    // Remove row
                    row.parentNode.removeChild(row);

                    // Update cart total
                    document.getElementById('cart-total-price').textContent = `₹${parseFloat(data.cart_total).toFixed(2)}`;

                    // If no items left, show empty cart message
                    if(document.querySelectorAll('.cart-item-row').length === 0){
                        const container = document.querySelector('.container.mt-4');
                        container.innerHTML = `
                            <p>Your cart is empty.</p>
                            <a href="{% url 'cake_list' %}" class="btn btn-primary">Continue Shopping</a>
                        `;
                    }
                } else {
                    alert(data.message || 'Failed to remove item.');
                }
            })
            .catch(() => alert('Error removing item. Please try again.'));
        });
    });
});
</script>

<style>
.quantity-input:focus {
    box-shadow: 0 0 5px rgba(25, 135, 84, 0.7);
    border-color: #198754;
}
.btn-remove-item {
    border-radius: 0.3rem;
    padding: 5px 9px;
    font-size: 0.9rem;
    line-height: 1;
    color: #fff;
    transition: background-color 0.3s ease;
}
.btn-remove-item:hover, .btn-remove-item:focus {
    background-color: #c82333;
    color: #fff;
}
</style>
{% endblock %}
