{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 1140px;">
    <h2 class="mb-4">Checkout</h2>

    {% if cart and cart.items.all %}
    <ul class="nav nav-tabs mb-4" id="checkoutTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="cart-summary-tab" data-bs-toggle="tab" data-bs-target="#cart-summary" type="button" role="tab" aria-controls="cart-summary" aria-selected="true">
                Cart Summary
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="addresses-tab" data-bs-toggle="tab" data-bs-target="#addresses" type="button" role="tab" aria-controls="addresses" aria-selected="false">
                Shipping Addresses
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="add-address-tab" data-bs-toggle="tab" data-bs-target="#add-address" type="button" role="tab" aria-controls="add-address" aria-selected="false">
                Add New Address
            </button>
        </li>
    </ul>

    <div class="tab-content" id="checkoutTabsContent">
        <!-- Cart Summary Tab -->
        <div class="tab-pane fade show active" id="cart-summary" role="tabpanel" aria-labelledby="cart-summary-tab">
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Cake</th>
                            <th>Variant</th>
                            <th>Quantity</th>
                            <th>Price (₹)</th>
                            <th>Total (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in cart.items.all %}
                        <tr>
                            <td>{{ item.variant.cake.title }}</td>
                            <td>{{ item.variant.weight }} kg</td>
                            <td>{{ item.quantity }}</td>
                            <td>₹{{ item.variant.price|floatformat:2 }}</td>
                            <td>₹{{ item.get_total_price|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p class="h5 text-end"><strong>Total: ₹{{ cart.get_total_price|floatformat:2 }}</strong></p>
        </div>

        <!-- Shipping Addresses Tab -->
        <div class="tab-pane fade" id="addresses" role="tabpanel" aria-labelledby="addresses-tab">
            {% if addresses %}
            <form method="post" class="mt-3" id="checkout-form">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="address_id" class="form-label fw-semibold">Select Shipping Address</label>
                    <select class="form-select" name="address_id" id="address_id" required>
                        <option value="" selected disabled>-- Select an address --</option>
                        {% for address in addresses %}
                        <option value="{{ address.id }}">
                            {{ address.address_line_1 }}, {{ address.city }}, {{ address.state }}, {{ address.pincode }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="payment_method" class="form-label fw-semibold">Payment Method</label>
                    <select class="form-select" name="payment_method" id="payment_method" required>
                        <option value="razorpay">Online Payment (Razorpay)</option>
                        <option value="cod">Cash On Delivery (COD)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="coupon_code" class="form-label fw-semibold">Coupon Code (Optional)</label>
                    <input type="text" name="coupon_code" id="coupon_code" class="form-control" placeholder="Enter coupon code">
                </div>

                <button type="submit" class="btn btn-success">Place Order</button>
            </form>
            {% else %}
            <div class="alert alert-warning mt-3">
                No saved addresses found. <br>
                Please add a shipping address in the "Add New Address" tab.
            </div>
            {% endif %}
        </div>

        <!-- Add New Address Tab -->
        <div class="tab-pane fade" id="add-address" role="tabpanel" aria-labelledby="add-address-tab">
            <form method="post" class="mt-3" action="{% url 'add_address_checkout' %}" id="add-address-form">
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="name" class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text" id="name" name="name" class="form-control" placeholder="Your name" required>
                    </div>
                    <div class="col-md-6">
                        <label for="phone" class="form-label">Phone <span class="text-danger">*</span></label>
                        <input type="tel" id="phone" name="phone" class="form-control" placeholder="Phone number" required>
                    </div>
                    <div class="col-md-12">
                        <label for="address_line_1" class="form-label">Address Line 1 <span class="text-danger">*</span></label>
                        <input type="text" id="address_line_1" name="address_line_1" class="form-control" placeholder="Street address" required>
                    </div>
                    <div class="col-md-12">
                        <label for="address_line_2" class="form-label">Address Line 2</label>
                        <input type="text" id="address_line_2" name="address_line_2" class="form-control" placeholder="Apartment, suite, etc. (optional)">
                    </div>
                    <div class="col-md-4">
                        <label for="city" class="form-label">City <span class="text-danger">*</span></label>
                        <input type="text" id="city" name="city" class="form-control" placeholder="City" required>
                    </div>
                    <div class="col-md-4">
                        <label for="state" class="form-label">State <span class="text-danger">*</span></label>
                        <input type="text" id="state" name="state" class="form-control" placeholder="State" required>
                    </div>
                    <div class="col-md-4">
                        <label for="pincode" class="form-label">PIN Code <span class="text-danger">*</span></label>
                        <input type="text" id="pincode" name="pincode" class="form-control" placeholder="Postal Code" required>
                    </div>
                    <div class="col-12 text-end mt-3">
                        <button type="submit" class="btn btn-primary">Add Address</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% else %}
        <div class="alert alert-warning">Your cart is empty. <a href="{% url 'cake_list' %}">Browse cakes</a></div>
    {% endif %}
</div>

<script>
    // Optional: Focus switch tabs when address added, show alert, etc.
    // You can add JS to enhance user experience if you use AJAX.
</script>
{% endblock %}
