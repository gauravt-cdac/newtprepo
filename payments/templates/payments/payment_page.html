{% load bootstrap5 %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Complete Your Payment - Cake Shop</title>

    {% bootstrap_css %}
    <style>
        body {
            background-color: #f8f9fa;
        }
        .payment-card {
            max-width: 480px;
            margin: 50px auto;
            box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
            border-radius: 0.5rem;
            background-color: white;
        }
        .payment-header {
            background-color: #007bff;
            color: white;
            padding: 1.5rem;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            text-align: center;
        }
        .payment-body {
            padding: 2rem;
            text-align: center;
        }
        .payment-body h3 {
            margin-bottom: 1rem;
        }
        .payment-button {
            width: 100%;
            padding: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
        }
    </style>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>

<div class="payment-card">
    <div class="payment-header">
        <h2>Complete Your Payment</h2>
    </div>
    <div class="payment-body">
        <h3>Order #{{ order.order_number }}</h3>
        <p><strong>Total Amount: ₹{{ order.total_amount }}</strong></p>
        <button id="rzp-button" class="btn btn-primary payment-button">
            Pay ₹{{ order.total_amount }}
        </button>
    </div>
</div>

<script>
    const options = {
        "key": "{{ razorpay_key_id }}", // Enter your Razorpay API Key
        "amount": "{{ amount }}",       // Amount in paise, must be int
        "currency": "INR",
        "name": "Cake Shop",
        "description": "Order #{{ order.order_number }}",
        "order_id": "{{ razorpay_order_id }}", // Razorpay order ID returned from backend
        "handler": function (response){
            // Send payment response to backend for verification
            fetch("{% url 'payment_success' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: new URLSearchParams({
                    "razorpay_payment_id": response.razorpay_payment_id,
                    "razorpay_order_id": response.razorpay_order_id,
                    "razorpay_signature": response.razorpay_signature,
                })
            }).then(res => res.json())
              .then(data => {
                  if (data.status === "payment successful" || data.status === "Payment successful") {
                      window.location.href = "{% url 'order_success' order.id %}";
                  } else {
                      alert("Payment verification failed. Please contact support.");
                  }
              }).catch(() => {
                  alert("Something went wrong. Please try again.");
              });
        },
        "prefill": {
            "name": "{{ order.user.get_full_name }}",
            "email": "{{ order.user.email }}",
            "contact": "{{ order.user.phone }}",
        },
        "theme": {
            "color": "#007bff"
        }
    };

    const rzp = new Razorpay(options);
    document.getElementById('rzp-button').addEventListener('click', function(e){
        rzp.open();
        e.preventDefault();
    });
</script>

{% bootstrap_javascript %}
</body>
</html>
